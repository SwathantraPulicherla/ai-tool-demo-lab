name: AI Test Execution

on:
  issues:
    types: [opened, labeled, edited]
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - 'ai/generated-tests/**'
  workflow_dispatch:  # Manual trigger for testing

# Allow GitHub Pages deployment
permissions:
  pages: write
  id-token: write
  contents: write  # required for pushing branches and creating PRs

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  cleanup-artifacts:
    if: contains(github.event.issue.labels.*.name, 'ai-test-run') || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && startsWith(github.head_ref, 'ai/generated-tests/'))
    runs-on: ubuntu-latest
    steps:
      - name: Delete in-progress github-pages artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'in_progress',
            });

            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id,
              });

              for (const artifact of artifacts.data.artifacts) {
                if (artifact.name === 'github-pages') {
                  console.log(`Deleting artifact ${artifact.id} from run ${run.id}`);
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      artifact_id: artifact.id,
                    });
                  } catch (error) {
                    console.log(`Failed to delete artifact ${artifact.id}: ${error.message}`);
                  }
                }
              }
            }

  run-tests:
    if: contains(github.event.issue.labels.*.name, 'ai-test-run') || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && startsWith(github.head_ref, 'ai/generated-tests/'))
    needs: cleanup-artifacts
    runs-on: ubuntu-latest
    outputs:
      coverage_available: ${{ steps.test-summary.outputs.coverage_available }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          path: target-repo

      - name: Checkout AI tools
        uses: actions/checkout@v4
        with:
          repository: SwathantraPulicherla/ai-test-runner
          path: ai-tools
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout AI test generator
        uses: actions/checkout@v4
        with:
          repository: SwathantraPulicherla/ai-c-test-generator
          path: ai-test-generator
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Upgrade pip and setuptools
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential lcov

      - name: Install AI test runner
        run: |
          cd ai-tools
          pip install -e .
          # Set PYTHONPATH to include ai-test-generator for imports
          echo "PYTHONPATH=$GITHUB_WORKSPACE/ai-test-generator:$PYTHONPATH" >> $GITHUB_ENV

      - name: Run AI tests
        id: test-execution
        continue-on-error: true
        run: |
          cd target-repo
          # Clean build directory to avoid CMake cache conflicts
          rm -rf build/
          ai-test-runner --verbose 2>&1

      - name: Generate test summary
        id: test-summary
        if: always()
        run: |
          cd target-repo

          # Extract test results from the output
          if [ -d "tests/test_reports" ]; then
            # Look for test summary lines
            TEST_SUMMARY=$(find tests/test_reports -name "*.txt" -exec cat {} \; | grep -E "(Overall Status|Individual Tests|PASSED|FAILED)" | head -10)

            if [ -z "$TEST_SUMMARY" ]; then
              TEST_SUMMARY=$(find tests/test_reports -name "*.txt" -exec head -20 {} \; | head -10)
            fi

            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$TEST_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=No test reports found" >> $GITHUB_OUTPUT
          fi

          # Check for coverage report
          if [ -d "tests/coverage_reports" ] && [ -f "tests/coverage_reports/index.html" ]; then
            echo "coverage_available=true" >> $GITHUB_OUTPUT
          else
            echo "coverage_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment test results on issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const testExitCode = '${{ steps.test-execution.outcome }}' === 'success';
            const testSummary = '${{ steps.test-summary.outputs.summary }}';
            const coverageAvailable = '${{ steps.test-summary.outputs.coverage_available }}';

            let body;
            if (testExitCode) {
              body = `[SUCCESS] **AI Test Execution Completed Successfully!**\n\n## Test Results\n\`\`\`\n${testSummary}\n\`\`\`\n\nAll tests passed! [SUCCESS]`;
            } else {
              body = `[FAILED] **AI Test Execution Completed with Failures**\n\n## Test Results\n\`\`\`\n${testSummary}\n\`\`\`\n\nSome tests failed. Please check the detailed test reports in the workflow artifacts.`;
            }

            if (coverageAvailable === 'true') {
              body += `\n\n## Coverage Report\n[COVERAGE] Coverage reports are available:\n- **GitHub Pages**: https://${context.repo.owner}.github.io/${context.repo.repo}/\n- **Download Artifacts**: Download the "test-reports" and "coverage-reports" artifacts from this workflow run to view detailed information.`;
            } else {
              body += `\n\n## Test Reports\n[REPORTS] Test reports are available in the "test-reports" artifact from this workflow run.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Create branch and PR for failing tests
        if: steps.test-execution.outcome == 'failure' && github.event_name != 'pull_request'
        id: create_fix_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          cd target-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          BRANCH="ai/generated-tests/${TIMESTAMP}"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
          git checkout -b "${BRANCH}"
          git add tests/ || true
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: add generated tests that need fixing (${TIMESTAMP})"
            git push --set-upstream origin "${BRANCH}"
            echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit"
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PR to fix failing tests
        if: steps.create_fix_pr.outputs.created == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.create_fix_pr.outputs.branch }}';
            const title = 'fix failing test values based on latest test run';
            const body = `## Test Failures Detected

The latest test run failed. The generated tests have been committed to this branch.

### Next Steps:
1. Assign the Copilot agent to this PR
2. Comment: \`@copilot fix the expected values in the failing unit tests based on actual runtime output in the test report.\`
3. Copilot will update the test files and push commits
4. CI will run again automatically
5. Review and merge when tests pass

### Test Summary:
\`\`\`
${{ steps.test-summary.outputs.summary }}
\`\`\`

Test reports are available in the workflow artifacts.`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              head: branch,
              base: 'main',
              body: body,
              maintainer_can_modify: true
            });

            console.log(`Created PR: ${pr.data.html_url}`);

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target-repo/tests/test_reports/
          retention-days: 30

      - name: Upload coverage reports archive
        if: always() && steps.test-summary.outputs.coverage_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: target-repo/tests/coverage_reports/
          retention-days: 30

  upload-pages-artifact:
    needs: run-tests
    if: needs.run-tests.outputs.coverage_available == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Remove existing github-pages artifacts for this run
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name === 'github-pages') {
                console.log(`Deleting existing artifact ${artifact.id} before upload`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }

      - name: Download coverage reports artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: coverage_reports

      - name: Upload coverage reports for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage_reports/

  deploy-coverage:
    needs: upload-pages-artifact
    if: always() && needs.upload-pages-artifact.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
